<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <title>RDKS Datenportal – Prototyp</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #0f172a;
            --bg-card: #111827;
            --accent: #22c55e;
            --accent-soft: rgba(34, 197, 94, 0.15);
            --text: #e5e7eb;
            --text-muted: #9ca3af;
            --border: #1f2937;
        }

        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                sans-serif;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: radial-gradient(circle at top, #1f2937 0, #020617 55%);
            color: var(--text);
        }

        .screen {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 32px;
        }

        .hidden {
            display: none !important;
        }

        .card {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 18px;
            padding: 28px 32px 32px;
            max-width: 420px;
            width: 100%;
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5);
        }

        h1 {
            margin: 0 0 8px;
            font-size: 1.5rem;
            letter-spacing: 0.03em;
        }

        .subtitle {
            margin: 0 0 20px;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        label {
            display: block;
            font-size: 0.85rem;
            margin-bottom: 4px;
            color: var(--text-muted);
        }

        input[type="text"],
        input[type="password"],
        input[type="search"] {
            width: 100%;
            padding: 9px 11px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #020617;
            color: var(--text);
            font-size: 0.9rem;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="search"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent-soft);
        }

        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            border: none;
            cursor: pointer;
            border-radius: 999px;
            padding: 9px 16px;
            font-size: 0.9rem;
            font-weight: 500;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #022c22;
            margin-top: 10px;
        }

        button.secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
        }

        .hint {
            margin-top: 12px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .error {
            margin-top: 8px;
            font-size: 0.8rem;
            color: #f97373;
        }

        /* App-Screen */

        #app-screen {
            flex-direction: column;
            align-items: stretch;
            justify-content: stretch;
            gap: 16px;
        }

        header.app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid rgba(31, 41, 55, 0.9);
            background: linear-gradient(
                to right,
                rgba(15, 23, 42, 0.98),
                rgba(15, 23, 42, 0.92)
            );
        }

        header .title {
            font-size: 1rem;
            font-weight: 500;
        }

        header .title span {
            display: block;
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        main.app-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 16px 20px 20px;
            gap: 12px;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(31, 41, 55, 0.9);
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .badge {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.15);
            color: var(--text-muted);
        }

        #record-count {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* KPI-Karten */

        .kpi-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 4px;
        }

        .kpi-card {
            flex: 0 0 auto;
            min-width: 120px;
            padding: 8px 12px;
            border-radius: 10px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(31, 41, 55, 0.9);
        }

        .kpi-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .kpi-value {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .kpi-ok {
            color: #4ade80;
        }

        .kpi-warn {
            color: #facc15;
        }

        .kpi-fail {
            color: #f97373;
        }

        #table-container {
            flex: 1;
            min-height: 240px;
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.96);
            border: 1px solid rgba(31, 41, 55, 0.9);
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        thead {
            background: rgba(15, 23, 42, 0.98);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        th,
        td {
            padding: 6px 10px;
            border-bottom: 1px solid rgba(31, 41, 55, 0.85);
            text-align: left;
            white-space: nowrap;
        }

        th {
            font-weight: 500;
            color: var(--text-muted);
        }

        tbody {
            display: block;
            max-height: calc(100vh - 260px);
            overflow: auto;
        }

        thead tr,
        tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        tbody tr:nth-child(even) {
            background: rgba(15, 23, 42, 0.96);
        }

        tbody tr:nth-child(odd) {
            background: rgba(15, 23, 42, 0.9);
        }

        tbody tr:hover {
            background: rgba(34, 197, 94, 0.08);
        }

        #empty-hint {
            margin: auto;
            padding: 20px;
            font-size: 0.9rem;
            color: var(--text-muted);
            text-align: center;
        }

        /* Status-Ampel mit Pill-Stil */

        td.status-ok,
        td.status-warn,
        td.status-fail {
            font-weight: 600;
            text-align: center;
        }

        td.status-ok::before,
        td.status-warn::before,
        td.status-fail::before {
            content: attr(data-status);
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.75rem;
        }

        td.status-ok::before {
            background: rgba(74, 222, 128, 0.15);
            color: #4ade80;
        }

        td.status-warn::before {
            background: rgba(250, 204, 21, 0.15);
            color: #facc15;
        }

        td.status-fail::before {
            background: rgba(248, 113, 113, 0.15);
            color: #f97373;
        }

        /* Status-Filter-Buttons */

        .status-filter-btn {
            background: transparent !important;
            border-radius: 999px;
            border: 1px solid var(--border);
            padding: 4px 10px;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 500;
            margin-top: 0;
        }

        .status-filter-btn.active {
            background: var(--accent-soft) !important;
            border-color: var(--accent);
            color: var(--accent);
        }

        @media (max-width: 720px) {
            .card {
                padding: 22px 18px 24px;
            }
            main.app-main {
                padding: 12px;
            }
            header.app-header {
                padding-inline: 12px;
            }
        }
    </style>
    <script src="/static/socket.io.js"></script>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="screen">
        <form id="login-form" class="card">
            <h1>RDKS Datenportal</h1>
            <p class="subtitle">
                Demo-Frontend für den End-of-Line&nbsp;Test (JSON-Tabelle &amp; Filter)
            </p>

            <div style="margin-bottom: 10px">
                <label for="username">Benutzername</label>
                <input
                    type="text"
                    id="username"
                    autocomplete="username"
                    required
                    placeholder="admin"
                />
            </div>

            <div style="margin-bottom: 6px">
                <label for="password">Passwort</label>
                <input
                    type="password"
                    id="password"
                    autocomplete="current-password"
                    required
                    placeholder="admin"
                />
            </div>

            <button type="submit">
                <span>Anmelden</span>
                <span>⮕</span>
            </button>

            <p id="login-error" class="error"></p>

            <p class="hint">
                Demo-Zugang: <b>admin / admin</b><br />
                Hinweis: Authentifizierung &amp; Rechteverwaltung laufen später über
                den Server.
            </p>
        </form>
    </div>

    <!-- APP SCREEN -->
    <div id="app-screen" class="screen hidden">
        <header class="app-header">
            <div class="title">
                RDKS Prüfprotokolle
                <span>Demo-Ansicht – JSON von Server</span>
            </div>
            <button id="logout-btn" class="secondary">Abmelden</button>
        </header>

        <main class="app-main">
            <section class="toolbar">
                <div class="toolbar-group">
                    <button id="load-data-btn" class="badge">
                        <span>JSON von Server laden</span>
                    </button>
                </div>

                <div class="toolbar-group status-filters">
                    <span class="badge">Status</span>
                    <button type="button" class="status-filter-btn active" data-status="ALL">
                        Alle
                    </button>
                    <button type="button" class="status-filter-btn" data-status="OK">
                        OK
                    </button>
                    <button type="button" class="status-filter-btn" data-status="WARN">
                        WARN
                    </button>
                    <button type="button" class="status-filter-btn" data-status="FAIL">
                        FAIL
                    </button>
                </div>

                <div class="toolbar-group" style="flex: 1 1 220px">
                    <input
                        type="search"
                        id="filter-input"
                        placeholder="Filter (Trailer-ID, Sensorposition, Status …)"
                    />
                </div>

                <div class="toolbar-group">
                    <button type="button" id="export-btn" class="secondary">
                        CSV exportieren
                    </button>
                </div>

                <span id="record-count"></span>
            </section>

            <section class="kpi-row">
                <div class="kpi-card">
                    <div class="kpi-label">Tests (sichtbar)</div>
                    <div id="kpi-total" class="kpi-value">0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">OK</div>
                    <div id="kpi-ok" class="kpi-value kpi-ok">0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">WARN</div>
                    <div id="kpi-warn" class="kpi-value kpi-warn">0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">FAIL</div>
                    <div id="kpi-fail" class="kpi-value kpi-fail">0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Yield</div>
                    <div id="kpi-yield" class="kpi-value">-</div>
                </div>
            </section>

            <section id="table-container">
                <table id="data-table">
                    <thead></thead>
                    <tbody></tbody>
                </table>
                <p id="empty-hint">
                    Noch keine Daten geladen. Klicke auf „JSON von Server laden“ oben.
                    <br />
                    <code>Beispiel-URL: /api/rdks-logs.json</code>
                </p>
            </section>
        </main>
    </div>

    <script>
        // --- LOGIN-LOGIK ------------------------------------------------------
        const loginForm = document.getElementById("login-form");
        const loginScreen = document.getElementById("login-screen");
        const appScreen = document.getElementById("app-screen");
        const logoutBtn = document.getElementById("logout-btn");
        const loginError = document.getElementById("login-error");

        loginForm.addEventListener("submit", (event) => {
            event.preventDefault();
            const user = document.getElementById("username").value.trim();
            const pass = document.getElementById("password").value.trim();

            if (user === "admin" && pass === "admin") {
                loginError.textContent = "";
                loginScreen.classList.add("hidden");
                appScreen.classList.remove("hidden");
                socket.emit('message', "init");
            } else {
                loginError.textContent = "Falscher Benutzername oder Passwort.";
            }
        });

        logoutBtn.addEventListener("click", () => {
            appScreen.classList.add("hidden");
            loginScreen.classList.remove("hidden");
        });

        // --- TABELLEN- & FILTER-LOGIK ----------------------------------------
        const loadDataBtn = document.getElementById("load-data-btn");
        const filterInput = document.getElementById("filter-input");
        const exportBtn = document.getElementById("export-btn");
        const table = document.getElementById("data-table");
        const thead = table.querySelector("thead");
        const tbody = table.querySelector("tbody");
        const recordCount = document.getElementById("record-count");
        const emptyHint = document.getElementById("empty-hint");
        const statusFilterButtons = document.querySelectorAll(".status-filter-btn");

        const kpiTotal = document.getElementById("kpi-total");
        const kpiOk = document.getElementById("kpi-ok");
        const kpiWarn = document.getElementById("kpi-warn");
        const kpiFail = document.getElementById("kpi-fail");
        const kpiYield = document.getElementById("kpi-yield");

        let fullData = []; // komplette JSON-Daten
        let visibleData = []; // gefilterte Ansicht
        let columns = []; // Spaltennamen
        let statusFilter = "ALL";

        // URL des JSON-Endpunkts (kann auf Server konfiguriert werden)
        const JSON_API_URL = "/api"; // Beispiel-URL
        const socket = io(); // Verbindung zur Flask-App
        
        socket.on('response', function(data) {
            console.log(data)
            // try {
            //     let json = JSON.parse(data);
            // }
            // catch {
            //     alert(
            //         "Die Antwort vom Server ist kein gültiges JSON-Array. Erwartet: [{...}, {...}]."
            //     );
            //     return;
            // }

            fullData = data;
            buildColumns();
            applyFilter();
            emptyHint.style.display = "none";

            
        });
        // loadDataBtn.addEventListener("click", async () => {
        //     try {
        //         const response = await fetch(JSON_API_URL,{Method:"GET"});
        //         if (!response.ok) {
        //             throw new Error(`HTTP error! status: ${response.status}`);
        //         }

        //         const json = await response.json();

        //         if (!Array.isArray(json)) {
        //             alert(
        //                 "Die Antwort vom Server ist kein gültiges JSON-Array. Erwartet: [{...}, {...}]."
        //             );
        //             return;
        //         }

        //         fullData = json;
        //         buildColumns();
        //         applyFilter();
        //         emptyHint.style.display = "none";
        //     } catch (err) {
        //         console.error("Fehler beim Laden der Daten:", err);
        //         alert(
        //             "Konnte die JSON-Daten vom Server nicht laden. Überprüfe die Netzwerkverbindung oder den Server-Endpunkt."
        //         );
        //     }
        // });

        filterInput.addEventListener("input", () => {
            applyFilter();
        });

        statusFilterButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
                statusFilterButtons.forEach((b) => b.classList.remove("active"));
                btn.classList.add("active");
                statusFilter = btn.dataset.status; // ALL, OK, WARN, FAIL
                applyFilter();
            });
        });

        function buildColumns() {
            const keys = new Set();

            fullData.forEach((row) => {
                if (row && typeof row === "object" && !Array.isArray(row)) {
                    Object.keys(row).forEach((k) => keys.add(k));
                }
            });

            columns = Array.from(keys);

            thead.innerHTML = "";
            const tr = document.createElement("tr");
            columns.forEach((col) => {
                const th = document.createElement("th");
                th.textContent = col;
                tr.appendChild(th);
            });
            thead.appendChild(tr);
        }

        function applyFilter() {
            const term = filterInput.value.toLowerCase().trim();

            visibleData = fullData.filter((row) => {
                // Statusfilter
                if (statusFilter !== "ALL") {
                    const st =
                        row && row.status != null
                            ? String(row.status).toUpperCase()
                            : "";
                    if (st !== statusFilter) return false;
                }

                // Textfilter
                if (!term) return true;

                return columns.some((col) => {
                    const value = row[col];
                    if (value === null || value === undefined) return false;
                    return String(value).toLowerCase().includes(term);
                });
            });

            renderBody();
        }

        function renderBody() {
            tbody.innerHTML = "";

            if (!fullData.length) {
                emptyHint.style.display = "block";
                recordCount.textContent = "";
                updateKpis();
                return;
            }

            emptyHint.style.display = "none";

            visibleData.forEach((row) => {
                const tr = document.createElement("tr");

                columns.forEach((col) => {
                    const td = document.createElement("td");
                    const value = row[col];

                    if (col === "status" && value != null) {
                        const normalized = String(value).toUpperCase();

                        if (normalized === "OK") {
                            td.classList.add("status-ok");
                            td.dataset.status = normalized;
                        } else if (normalized === "WARN" || normalized === "WARNING") {
                            td.classList.add("status-warn");
                            td.dataset.status = normalized;
                        } else if (normalized === "FAIL" || normalized === "ERROR") {
                            td.classList.add("status-fail");
                            td.dataset.status = normalized;
                        } else {
                            td.textContent = normalized;
                        }
                    } else {
                        td.textContent =
                            value === undefined || value === null ? "" : value;
                    }

                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });

            recordCount.textContent = `${visibleData.length} / ${
                fullData.length
            } Datensätze angezeigt`;

            updateKpis();
        }

        function updateKpis() {
            const total = visibleData.length;
            let ok = 0,
                warn = 0,
                fail = 0;

            visibleData.forEach((row) => {
                const st =
                    row && row.status != null
                        ? String(row.status).toUpperCase()
                        : "";
                if (st === "OK") ok++;
                else if (st === "WARN" || st === "WARNING") warn++;
                else if (st === "FAIL" || st === "ERROR") fail++;
            });

            kpiTotal.textContent = total;
            kpiOk.textContent = ok;
            kpiWarn.textContent = warn;
            kpiFail.textContent = fail;

            if (total > 0) {
                const yieldPercent = (ok / total) * 100;
                kpiYield.textContent = yieldPercent.toFixed(1) + " %";
            } else {
                kpiYield.textContent = "-";
            }
        }

        // --- CSV-Export der gefilterten Daten --------------------------------
        exportBtn.addEventListener("click", exportFilteredToCSV);

        function exportFilteredToCSV() {
            if (!visibleData.length || !columns.length) {
                alert(
                    "Keine Daten zum Exportieren. Bitte zuerst Daten vom Server laden."
                );
                return;
            }

            const sep = ";"; // für DE-Excel angenehm
            const lines = [];

            // Header
            lines.push(columns.join(sep));

            // Zeilen
            visibleData.forEach((row) => {
                const values = columns.map((col) => {
                    let v = row[col];
                    if (v === null || v === undefined) return "";
                    v = String(v);

                    if (v.includes('"')) v = v.replace(/"/g, '""');
                    if (v.includes(sep) || v.includes("\n") || v.includes("\r")) {
                        v = `"${v}"`;
                    }
                    return v;
                });
                lines.push(values.join(sep));
            });

            const csvContent = lines.join("\r\n");
            const blob = new Blob([csvContent], {
                type: "text/csv;charset=utf-8;",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");

            const now = new Date();
            const timestamp = now
                .toISOString()
                .slice(0, 19)
                .replace(/[:T]/g, "-");

            a.href = url;
            a.download = `rdks_export_${timestamp}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initial leere KPIs anzeigen
        updateKpis();
    </script>
</body>
</html>